# ══════════════════════════════════════════════════════════════
# Smart Lighting v3 - Sala, Corredor e Cozinha
# ══════════════════════════════════════════════════════════════
#
# Sala - controle individual por lampada (calibracao real):
#   Fita LED Central: 630 lux @100% (sala + corredor)
#   DifusaMesa:       240 lux @100% (efetiva acima de 60%)
#   Porta Entrada:    200 lux @100% (satura rapido)
#   Spots QD1-3:      ~25 lux @100% (direcionais, acento)
#
# Corredor - 3 fitas LED (RGB, sem kelvin):
#   Fita LED Banheiros: ilumina todo o corredor (principal)
#   Fita LED Central:   corredor + sala (compartilhada)
#   Fita LED Quartos:   parte corredor + parte sala (compartilhada)
#   Zona de passagem: timeouts curtos, brilho moderado
#
# Sala lux alvo por horario:
#   06h=150 → 09h=300 → 12-17h=350 → 21h=120 → 23h=40
#
# Corredor lux alvo (mais baixo, zona de passagem):
#   06h=30 → 09h=120 → 12-17h=150 → 21h=60 → 23h=20
#
# Kelvin circadiano (CCT lights only):
#   06h=2700K → 12h=4000K → 20h=3000K → 23h=2500K

# ── Master switch: desliga modo automatico ──
input_boolean:
  smart_light_enabled:
    name: "Smart Light - Modo Auto"
    icon: mdi:lightbulb-auto

# ── Timer: override manual ──
timer:
  smart_light_sala_manual:
    name: "Sala - Pausa Modo Auto"
    duration: "00:30:00"
  smart_light_corredor_manual:
    name: "Corredor - Pausa Modo Auto"
    duration: "00:30:00"
  smart_light_cozinha_manual:
    name: "Cozinha - Pausa Modo Auto"
    duration: "00:30:00"
  smart_light_escritorio_manual:
    name: "Escritorio - Pausa Modo Auto"
    duration: "00:30:00"

# ── Calibracao: lux por lampada a 100% ──
input_number:
  cal_sala_led_meio:
    name: "Cal: LED Meio (lux@100%)"
    min: 0
    max: 2000
    step: 1
    initial: 630
    icon: mdi:led-strip
  cal_sala_difusa:
    name: "Cal: DifusaMesa (lux@100%)"
    min: 0
    max: 2000
    step: 1
    initial: 240
    icon: mdi:ceiling-light
  cal_sala_porta:
    name: "Cal: Porta Entrada (lux@100%)"
    min: 0
    max: 2000
    step: 1
    initial: 200
    icon: mdi:wall-sconce-flat
  cal_coz_luz:
    name: "Cal: Cozinha Luz (lux@100%)"
    min: 100
    max: 2000
    step: 10
    initial: 570
    icon: mdi:ceiling-light
  coz_learned_br_0:
    name: "Coz Learned: Madrugada %"
    min: 0
    max: 100
    step: 1
    initial: 30
    icon: mdi:lightbulb-auto
  coz_learned_br_1:
    name: "Coz Learned: Manha Cedo %"
    min: 0
    max: 100
    step: 1
    initial: 60
    icon: mdi:lightbulb-auto
  coz_learned_br_2:
    name: "Coz Learned: Manha %"
    min: 0
    max: 100
    step: 1
    initial: 55
    icon: mdi:lightbulb-auto
  coz_learned_br_3:
    name: "Coz Learned: Tarde %"
    min: 0
    max: 100
    step: 1
    initial: 50
    icon: mdi:lightbulb-auto
  coz_learned_br_4:
    name: "Coz Learned: Entardecer %"
    min: 0
    max: 100
    step: 1
    initial: 65
    icon: mdi:lightbulb-auto
  coz_learned_br_5:
    name: "Coz Learned: Noite %"
    min: 0
    max: 100
    step: 1
    initial: 70
    icon: mdi:lightbulb-auto
  # ── Brilho minimo de conforto por ambiente ──
  # Calibrado in-loco: valor abaixo do qual o ambiente fica desconfortavel.
  # O sensor pode ler lux alto (posicao frontal a lampada) mas o ambiente
  # precisa de um minimo de luz artificial para conforto real.
  min_brilho_sala:
    name: "Sala - Brilho Minimo %"
    min: 0
    max: 100
    step: 5
    initial: 25
    icon: mdi:brightness-4
  min_brilho_corredor:
    name: "Corredor - Brilho Minimo %"
    min: 0
    max: 100
    step: 5
    initial: 15
    icon: mdi:brightness-4
  min_brilho_cozinha:
    name: "Cozinha - Brilho Minimo %"
    min: 0
    max: 100
    step: 5
    initial: 40
    icon: mdi:brightness-4
  min_brilho_escritorio:
    name: "Escritorio - Brilho Minimo %"
    min: 0
    max: 100
    step: 5
    initial: 40
    icon: mdi:brightness-4

# ── Sensor: media movel varanda ──
sensor:
  - platform: statistics
    name: "Varanda Lux Media 3d"
    unique_id: varanda_lux_media_3d
    entity_id: sensor.sensor_varanda_iluminancia
    state_characteristic: mean
    max_age:
      days: 3

# ── Sensores calculados ──
template:
  - sensor:
      # Lux alvo para o horario atual
      - name: "Sala Lux Alvo"
        unique_id: sala_lux_alvo
        unit_of_measurement: "lx"
        icon: mdi:sun-compass
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}40
          {% elif h < 9 %}{{ (150 + (h - 6) * 50) | round(0) }}
          {% elif h < 12 %}{{ (300 + (h - 9) * 17) | round(0) }}
          {% elif h < 17 %}350
          {% elif h < 21 %}{{ (350 - (h - 17) * 57) | round(0) }}
          {% elif h < 23 %}{{ (120 - (h - 21) * 40) | round(0) }}
          {% else %}40{% endif %}

      # Luz natural estimada (total - artificial conhecida)
      - name: "Sala Lux Natural"
        unique_id: sala_lux_natural
        unit_of_measurement: "lx"
        icon: mdi:white-balance-sunny
        state: >
          {% set total = states('sensor.sensor_sala_iluminancia') | float(0) %}
          {% set cal_led = states('input_number.cal_sala_led_meio') | float(630) %}
          {% set cal_dif = states('input_number.cal_sala_difusa') | float(240) %}
          {% set cal_por = states('input_number.cal_sala_porta') | float(200) %}
          {% set br_led = state_attr('light.addressable_v3_5v_8df0af', 'brightness') | float(0) %}
          {% set br_dif = state_attr('light.tz3210_nvaik6gk_ts0502b_luz_4', 'brightness') | float(0) %}
          {% set br_por = state_attr('light.luz_porta_entrada_luz_3', 'brightness') | float(0) %}
          {% set artificial = (br_led/255*cal_led) + (br_dif/255*cal_dif) + (br_por/255*cal_por) %}
          {{ [total - artificial, 0] | max | round(0) }}

      # Fator de compensacao (0=luz natural suficiente, 1=escuro total)
      - name: "Sala Compensacao"
        unique_id: sala_compensacao
        unit_of_measurement: ""
        icon: mdi:tune-vertical
        state: >
          {% set natural = states('sensor.sala_lux_natural') | float(0) %}
          {% set alvo = states('sensor.sala_lux_alvo') | float(200) %}
          {{ [[1 - natural / (alvo + 0.1), 0] | max, 1] | min | round(2) }}

      # Kelvin circadiano
      - name: "Iluminacao Kelvin Alvo"
        unique_id: iluminacao_kelvin_alvo
        unit_of_measurement: "K"
        icon: mdi:sun-thermometer
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}{{ 2500 }}
          {% elif h < 9 %}{{ (2700 + (h - 6) * 200) | round(0) }}
          {% elif h < 12 %}{{ (3300 + (h - 9) * 233) | round(0) }}
          {% elif h < 16 %}{{ 4000 }}
          {% elif h < 20 %}{{ (4000 - (h - 16) * 250) | round(0) }}
          {% elif h < 23 %}{{ (3000 - (h - 20) * 167) | round(0) }}
          {% else %}{{ 2500 }}{% endif %}

      # Cozinha lux alvo fixo (390 lx = referencia 07:15 com 5700K)
      - name: "Cozinha Lux Alvo"
        unique_id: cozinha_lux_alvo
        unit_of_measurement: "lx"
        icon: mdi:sun-compass
        state: "390"

      # Cozinha kelvin alvo - ajuste fino de luminosidade percebida
      # Manha: 5700-6500K (frio, mais claridade para tarefas)
      # Noite: 4500-6200K (faixa ampla, mais quente)
      - name: "Cozinha Kelvin Alvo"
        unique_id: cozinha_kelvin_alvo
        unit_of_measurement: "K"
        icon: mdi:sun-thermometer
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}4500
          {% elif h < 8 %}{{ (5700 + (h - 6) * 150) | round(0) }}
          {% elif h < 12 %}{{ (6000 + (h - 8) * 125) | round(0) }}
          {% elif h < 17 %}6500
          {% elif h < 20 %}{{ (6200 - (h - 17) * 400) | round(0) }}
          {% elif h < 23 %}{{ (5000 - (h - 20) * 167) | round(0) }}
          {% else %}4500{% endif %}

      # Cozinha feedback: erro % entre lux atual e alvo
      - name: "Cozinha Feedback Erro"
        unique_id: cozinha_feedback_erro
        unit_of_measurement: "%"
        state: >
          {% set atual = states('sensor.sensor_cozinha_iluminancia') | float(0) %}
          {% set alvo = states('sensor.cozinha_lux_alvo') | float(390) %}
          {% if alvo > 0 %}
            {{ ((atual - alvo) / alvo * 100) | round(1) }}
          {% else %}0{% endif %}

      # Cozinha feedback: fase do controlador
      - name: "Cozinha Feedback Fase"
        unique_id: cozinha_feedback_fase
        state: >
          {% set erro = states('sensor.cozinha_feedback_erro') | float(0) | abs %}
          {% if erro > 5 %}brilho
          {% elif erro > 2 %}kelvin
          {% else %}estavel{% endif %}

      # Cozinha: slot horario atual (0-5)
      - name: "Cozinha Slot Horario"
        unique_id: cozinha_slot_horario
        state: >
          {% set h = now().hour %}
          {% if h < 6 %}0{% elif h < 9 %}1{% elif h < 12 %}2
          {% elif h < 17 %}3{% elif h < 20 %}4{% else %}5{% endif %}

      # Cozinha: confianca baseada na varanda (current vs 3d mean)
      - name: "Cozinha Confianca Varanda"
        unique_id: cozinha_confianca_varanda
        unit_of_measurement: "%"
        state: >
          {% set atual = states('sensor.sensor_varanda_iluminancia') | float(1) %}
          {% set media = states('sensor.varanda_lux_media_3d') | float(1) %}
          {% set desvio = ((atual - media) / media * 100) | abs %}
          {{ [100 - desvio, 0] | max | round(0) }}

      # Escritorio lux alvo (ambiente de trabalho, precisa de bastante luz)
      # 06h=200 → 09h=500 → 12-17h=600 → 21h=300 → 23h=100
      - name: "Escritorio Lux Alvo"
        unique_id: escritorio_lux_alvo
        unit_of_measurement: "lx"
        icon: mdi:sun-compass
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}100
          {% elif h < 9 %}{{ (200 + (h - 6) * 100) | round(0) }}
          {% elif h < 12 %}{{ (500 + (h - 9) * 33) | round(0) }}
          {% elif h < 17 %}600
          {% elif h < 21 %}{{ (600 - (h - 17) * 75) | round(0) }}
          {% elif h < 23 %}{{ (300 - (h - 21) * 100) | round(0) }}
          {% else %}100{% endif %}

      # Escritorio brilho alvo (4 luzes CCT)
      - name: "Escritorio Brilho Alvo"
        unique_id: escritorio_brilho_alvo
        unit_of_measurement: "%"
        icon: mdi:brightness-percent
        state: >
          {% set lux = states('sensor.sensor_escritorio_iluminancia') | float(0) %}
          {% set alvo = states('sensor.escritorio_lux_alvo') | float(500) %}
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}{% set mb = 25 %}
          {% elif h < 9 %}{% set mb = 70 %}
          {% elif h < 17 %}{% set mb = 90 %}
          {% elif h < 21 %}{% set mb = 75 %}
          {% elif h < 23 %}{% set mb = 45 %}
          {% else %}{% set mb = 25 %}{% endif %}
          {% set factor = [[1.0 - lux / (alvo + 0.1), 0.0] | max, 1.0] | min %}
          {% set minimo = states('input_number.min_brilho_escritorio') | int(40) %}
          {{ [(mb * factor) | round(0), minimo] | max }}

      # Corredor lux alvo (zona de passagem, mais baixo que sala)
      - name: "Corredor Lux Alvo"
        unique_id: corredor_lux_alvo
        unit_of_measurement: "lx"
        icon: mdi:sun-compass
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% if h < 6 %}20
          {% elif h < 9 %}{{ (60 + (h - 6) * 20) | round(0) }}
          {% elif h < 12 %}{{ (120 + (h - 9) * 10) | round(0) }}
          {% elif h < 17 %}150
          {% elif h < 21 %}{{ (150 - (h - 17) * 22) | round(0) }}
          {% elif h < 23 %}{{ (60 - (h - 21) * 20) | round(0) }}
          {% else %}20{% endif %}

      # Corredor brilho alvo para Fita LED Banheiros (principal do corredor)
      - name: "Corredor Brilho Alvo"
        unique_id: corredor_brilho_alvo
        unit_of_measurement: "%"
        icon: mdi:brightness-percent
        state: >
          {% set h = now().hour + now().minute / 60.0 %}
          {% set lux = states('sensor.sensor_corredor_iluminancia') | float(0) %}
          {% set alvo = states('sensor.corredor_lux_alvo') | float(80) %}
          {% set presence = is_state('binary_sensor.sensor_corredor', 'on') %}
          {% if not presence %}0
          {% else %}
            {% if h < 6 %}{% set mb = 8 %}
            {% elif h < 9 %}{% set mb = 30 %}
            {% elif h < 17 %}{% set mb = 45 %}
            {% elif h < 21 %}{% set mb = 35 %}
            {% elif h < 23 %}{% set mb = 20 %}
            {% else %}{% set mb = 8 %}{% endif %}
            {% set factor = [[1.0 - lux / (alvo + 0.1), 0.0] | max, 1.0] | min %}
            {% set minimo = states('input_number.min_brilho_corredor') | int(15) %}
            {{ [(mb * factor) | round(0), minimo] | max }}
          {% endif %}

# ── Script de calibracao ──
script:
  calibrar_luzes_sala:
    alias: "Calibrar Luzes Sala"
    icon: mdi:tune
    description: >
      Desliga todas as luzes, mede baseline, liga cada luz a 100%,
      aguarda sensor atualizar, e armazena contribuicao em lux.
      Executar preferencialmente a noite (sem luz natural).
    sequence:
      # Desliga tudo
      - action: light.turn_off
        target:
          entity_id:
            - light.tz3210_nvaik6gk_ts0502b_luz_4
            - light.addressable_v3_5v_8df0af
            - light.luz_porta_entrada_luz_3
            - light.tz3210_swa1zqs0_ts0502b_luz_5
            - light.tz3210_swa1zqs0_ts0502b_luz_4
            - light.tz3210_swa1zqs0_ts0502b_luz_7
      - delay: {seconds: 30}
      # Baseline
      - variables:
          baseline: "{{ states('sensor.sensor_sala_iluminancia') | float(0) }}"
      # LED Meio
      - action: light.turn_on
        target:
          entity_id: light.addressable_v3_5v_8df0af
        data:
          brightness_pct: 100
      - wait_for_trigger:
          - trigger: state
            entity_id: sensor.sensor_sala_iluminancia
        timeout: {seconds: 60}
      - delay: {seconds: 10}
      - action: input_number.set_value
        target:
          entity_id: input_number.cal_sala_led_meio
        data:
          value: "{{ [(states('sensor.sensor_sala_iluminancia') | float(0) - baseline) | round(0), 1] | max }}"
      - action: light.turn_off
        target:
          entity_id: light.addressable_v3_5v_8df0af
      - wait_for_trigger:
          - trigger: state
            entity_id: sensor.sensor_sala_iluminancia
        timeout: {seconds: 60}
      - delay: {seconds: 10}
      # DifusaMesa
      - action: light.turn_on
        target:
          entity_id: light.tz3210_nvaik6gk_ts0502b_luz_4
        data:
          brightness_pct: 100
      - wait_for_trigger:
          - trigger: state
            entity_id: sensor.sensor_sala_iluminancia
        timeout: {seconds: 60}
      - delay: {seconds: 10}
      - action: input_number.set_value
        target:
          entity_id: input_number.cal_sala_difusa
        data:
          value: "{{ [(states('sensor.sensor_sala_iluminancia') | float(0) - baseline) | round(0), 1] | max }}"
      - action: light.turn_off
        target:
          entity_id: light.tz3210_nvaik6gk_ts0502b_luz_4
      - wait_for_trigger:
          - trigger: state
            entity_id: sensor.sensor_sala_iluminancia
        timeout: {seconds: 60}
      - delay: {seconds: 10}
      # Porta Entrada
      - action: light.turn_on
        target:
          entity_id: light.luz_porta_entrada_luz_3
        data:
          brightness_pct: 100
      - wait_for_trigger:
          - trigger: state
            entity_id: sensor.sensor_sala_iluminancia
        timeout: {seconds: 60}
      - delay: {seconds: 10}
      - action: input_number.set_value
        target:
          entity_id: input_number.cal_sala_porta
        data:
          value: "{{ [(states('sensor.sensor_sala_iluminancia') | float(0) - baseline) | round(0), 1] | max }}"
      - action: light.turn_off
        target:
          entity_id: light.luz_porta_entrada_luz_3
      - action: persistent_notification.create
        data:
          title: "Calibracao Concluida"
          message: >
            LED Meio: {{ states('input_number.cal_sala_led_meio') }} lux |
            DifusaMesa: {{ states('input_number.cal_sala_difusa') }} lux |
            Porta: {{ states('input_number.cal_sala_porta') }} lux
    mode: single

# ── Automacoes ──
automation:
  # ─── SALA: detecta override manual do painel ───
  - id: smart_light_sala_manual_override
    alias: Smart Light Sala - Override Manual
    description: Pausa modo auto 30min ao pressionar botao do painel
    triggers:
      - trigger: state
        entity_id:
          - switch.painel_botoes_6x1_sala_switch_1
          - switch.painel_botoes_6x1_sala_switch_2
          - switch.painel_botoes_6x1_sala_switch_3
          - switch.painel_botoes_6x1_sala_switch_4
          - switch.painel_botoes_6x1_sala_switch_5
          - switch.painel_botoes_6x1_sala_switch_6
    conditions:
      - condition: template
        value_template: "{{ trigger.to_state.context.user_id != none }}"
    actions:
      - action: timer.start
        target:
          entity_id: timer.smart_light_sala_manual
    mode: restart

  # ─── CORREDOR: detecta override manual ───
  - id: smart_light_corredor_manual_override
    alias: Smart Light Corredor - Override Manual
    description: Pausa modo auto 30min ao controlar luz manualmente
    triggers:
      - trigger: state
        entity_id:
          - light.addressable_v3_5v_954613
          - light.addressable_v3_5v_8df0af
          - light.addressable_v3_5v_8eeb93
    conditions:
      - condition: template
        value_template: "{{ trigger.to_state.context.user_id != none }}"
    actions:
      - action: timer.start
        target:
          entity_id: timer.smart_light_corredor_manual
    mode: restart

  # ─── COZINHA: detecta override manual ───
  - id: smart_light_cozinha_manual_override
    alias: Smart Light Cozinha - Override Manual
    description: Pausa modo auto 30min ao controlar luz manualmente
    triggers:
      - trigger: state
        entity_id: light.cz05_cozinha_luz
    conditions:
      - condition: template
        value_template: "{{ trigger.to_state.context.user_id != none }}"
    actions:
      - action: timer.start
        target:
          entity_id: timer.smart_light_cozinha_manual
    mode: restart

  # ─── SALA: controle individual inteligente ───
  - id: smart_light_sala_on
    alias: Smart Light Sala - Ajuste Inteligente
    description: >
      Controle individual por lampada. Estima luz natural subtraindo
      contribuicao artificial calibrada. Perfil diferente por horario:
      manha=LED+difusa, dia=LED+difusa+spots, tarde=tudo, noite=difusa.
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_sala
        to: "on"
      - trigger: time_pattern
        minutes: "/3"
    conditions:
      - condition: state
        entity_id: input_boolean.smart_light_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.sensor_sala
        state: "on"
      - condition: state
        entity_id: timer.smart_light_sala_manual
        state: "idle"
    actions:
      - variables:
          h: "{{ now().hour + now().minute / 60.0 }}"
          kelvin: "{{ states('sensor.iluminacao_kelvin_alvo') | int(3000) }}"
          comp: "{{ states('sensor.sala_compensacao') | float(1) }}"
          # ── Perfil por lampada e horario (brilho base a 0 lux) ──
          # LED Meio: principal durante dia, desliga a noite
          led_meio: >
            {% set c = comp | float %}
            {% if h | float < 6 %}0
            {% elif h | float < 9 %}{{ (35 * c) | round(0) }}
            {% elif h | float < 17 %}{{ (50 * c) | round(0) }}
            {% elif h | float < 21 %}{{ (40 * c) | round(0) }}
            {% else %}0{% endif %}
          # DifusaMesa: sempre presente, luz de ambiente (respeita minimo)
          min_sala: "{{ states('input_number.min_brilho_sala') | int(25) }}"
          difusa: >
            {% set c = comp | float %}
            {% set mn = min_sala | int(25) %}
            {% if h | float < 6 %}{{ [(25 * c) | round(0), mn] | max }}
            {% elif h | float < 9 %}{{ [(45 * c) | round(0), mn] | max }}
            {% elif h | float < 17 %}{{ [(60 * c) | round(0), mn] | max }}
            {% elif h | float < 21 %}{{ [(70 * c) | round(0), mn] | max }}
            {% elif h | float < 23 %}{{ [(55 * c) | round(0), mn] | max }}
            {% else %}{{ [(20 * c) | round(0), mn] | max }}{% endif %}
          # Porta Entrada: complemento dia/tarde (satura rapido, max 35%)
          porta: >
            {% set c = comp | float %}
            {% if h | float < 9 %}0
            {% elif h | float < 17 %}{{ (25 * c) | round(0) }}
            {% elif h | float < 21 %}{{ (35 * c) | round(0) }}
            {% else %}0{% endif %}
          # Spots: acento visual dia/tarde, desligam a noite
          spots: >
            {% set c = comp | float %}
            {% if h | float < 9 %}0
            {% elif h | float < 17 %}{{ (35 * c) | round(0) }}
            {% elif h | float < 21 %}{{ (55 * c) | round(0) }}
            {% elif h | float < 23 %}{{ (20 * c) | round(0) }}
            {% else %}0{% endif %}
      # ── Aplica brilho individual ──
      # DifusaMesa (CCT)
      - if:
          - condition: template
            value_template: "{{ difusa | int > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id: light.tz3210_nvaik6gk_ts0502b_luz_4
            data:
              brightness_pct: "{{ difusa }}"
              kelvin: "{{ kelvin }}"
              transition: 3
        else:
          - action: light.turn_off
            target:
              entity_id: light.tz3210_nvaik6gk_ts0502b_luz_4
            data:
              transition: 5
      # LED Meio (RGB)
      - if:
          - condition: template
            value_template: "{{ led_meio | int > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id: light.addressable_v3_5v_8df0af
            data:
              brightness_pct: "{{ led_meio }}"
              transition: 3
        else:
          - action: light.turn_off
            target:
              entity_id: light.addressable_v3_5v_8df0af
            data:
              transition: 5
      # Porta Entrada (CCT)
      - if:
          - condition: template
            value_template: "{{ porta | int > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id: light.luz_porta_entrada_luz_3
            data:
              brightness_pct: "{{ porta }}"
              kelvin: "{{ kelvin }}"
              transition: 3
        else:
          - action: light.turn_off
            target:
              entity_id: light.luz_porta_entrada_luz_3
            data:
              transition: 5
      # Spots QD001, QD002, QD003 (CCT)
      - if:
          - condition: template
            value_template: "{{ spots | int > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id:
                - light.tz3210_swa1zqs0_ts0502b_luz_5
                - light.tz3210_swa1zqs0_ts0502b_luz_4
                - light.tz3210_swa1zqs0_ts0502b_luz_7
            data:
              brightness_pct: "{{ spots }}"
              kelvin: "{{ kelvin }}"
              transition: 3
        else:
          - action: light.turn_off
            target:
              entity_id:
                - light.tz3210_swa1zqs0_ts0502b_luz_5
                - light.tz3210_swa1zqs0_ts0502b_luz_4
                - light.tz3210_swa1zqs0_ts0502b_luz_7
            data:
              transition: 5
    mode: restart

  # ─── SALA: desligar sem presenca ───
  - id: smart_light_sala_off
    alias: Smart Light Sala - Sem Presenca
    description: >
      Fade-out apos timeout sem presenca.
      15min noite (TV/leitura), 10min dia, 3min madrugada.
      Fitas LED compartilhadas so desligam se corredor tambem sem presenca.
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_sala
        to: "off"
    actions:
      - delay:
          minutes: >
            {% set h = now().hour %}
            {% if 17 <= h < 23 %}15
            {% elif 8 <= h < 17 %}10
            {% else %}3{% endif %}
      - condition: state
        entity_id: binary_sensor.sensor_sala
        state: "off"
      # Luzes exclusivas da sala - desliga sempre
      - action: light.turn_off
        target:
          entity_id:
            - light.tz3210_nvaik6gk_ts0502b_luz_4
            - light.luz_porta_entrada_luz_3
            - light.tz3210_swa1zqs0_ts0502b_luz_5
            - light.tz3210_swa1zqs0_ts0502b_luz_4
            - light.tz3210_swa1zqs0_ts0502b_luz_7
        data:
          transition: 10
      # Fitas LED compartilhadas - so desliga se corredor tambem vazio
      - if:
          - condition: state
            entity_id: binary_sensor.sensor_corredor
            state: "off"
        then:
          - action: light.turn_off
            target:
              entity_id:
                - light.addressable_v3_5v_8df0af
                - light.addressable_v3_5v_8eeb93
            data:
              transition: 10
      - action: switch.turn_off
        target:
          entity_id:
            - switch.painel_botoes_6x1_sala_switch_1
            - switch.painel_botoes_6x1_sala_switch_2
            - switch.painel_botoes_6x1_sala_switch_3
            - switch.painel_botoes_6x1_sala_switch_4
            - switch.painel_botoes_6x1_sala_switch_5
            - switch.painel_botoes_6x1_sala_switch_6
      - action: timer.cancel
        target:
          entity_id: timer.smart_light_sala_manual
    mode: restart

  # ─── CORREDOR: ajuste com presenca ───
  - id: smart_light_corredor_on
    alias: Smart Light Corredor - Ajuste Presenca
    description: >
      Controla 3 fitas LED do corredor por presenca e lux.
      Fita Banheiros=principal corredor, Central e Quartos=compartilhadas.
      So ajusta fitas compartilhadas se sala sem presenca (evita conflito).
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_corredor
        to: "on"
      - trigger: time_pattern
        minutes: "/3"
    conditions:
      - condition: state
        entity_id: input_boolean.smart_light_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.sensor_corredor
        state: "on"
      - condition: state
        entity_id: timer.smart_light_corredor_manual
        state: "idle"
    actions:
      - variables:
          brilho: "{{ states('sensor.corredor_brilho_alvo') | int(0) }}"
          # Fitas compartilhadas: brilho reduzido (50% do principal)
          brilho_comp: "{{ [(brilho * 0.5) | round(0), 3] | max if brilho > 2 else 0 }}"
          sala_vazia: "{{ is_state('binary_sensor.sensor_sala', 'off') }}"
      # Fita LED Banheiros - principal do corredor, controle direto
      - if:
          - condition: template
            value_template: "{{ brilho > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id: light.addressable_v3_5v_954613
            data:
              brightness_pct: "{{ brilho }}"
              transition: 2
        else:
          - action: light.turn_off
            target:
              entity_id: light.addressable_v3_5v_954613
            data:
              transition: 3
      # Fitas compartilhadas - so ajusta se sala vazia (senao sala controla)
      - if:
          - condition: template
            value_template: "{{ sala_vazia and brilho_comp > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id:
                - light.addressable_v3_5v_8df0af
                - light.addressable_v3_5v_8eeb93
            data:
              brightness_pct: "{{ brilho_comp }}"
              transition: 2
    mode: restart

  # ─── CORREDOR: desligar sem presenca ───
  - id: smart_light_corredor_off
    alias: Smart Light Corredor - Sem Presenca
    description: >
      Desliga fitas LED apos timeout curto (zona de passagem).
      3min dia, 1min madrugada. Fitas compartilhadas so desligam
      se sala tambem sem presenca.
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_corredor
        to: "off"
    actions:
      - delay:
          minutes: >
            {% set h = now().hour %}
            {% if 8 <= h < 22 %}3
            {% else %}1{% endif %}
      - condition: state
        entity_id: binary_sensor.sensor_corredor
        state: "off"
      # Fita Banheiros - exclusiva do corredor, desliga sempre
      - action: light.turn_off
        target:
          entity_id: light.addressable_v3_5v_954613
        data:
          transition: 5
      # Fitas compartilhadas - so desliga se sala tambem vazia
      - if:
          - condition: state
            entity_id: binary_sensor.sensor_sala
            state: "off"
        then:
          - action: light.turn_off
            target:
              entity_id:
                - light.addressable_v3_5v_8df0af
                - light.addressable_v3_5v_8eeb93
            data:
              transition: 5
    mode: restart

  # ─── COZINHA: controlador feedback inteligente ───
  - id: smart_light_cozinha_feedback
    alias: Smart Light Cozinha - Feedback Controller
    description: >
      Controlador proporcional com 4 fases: liga com baseline aprendido,
      ajusta brilho (erro >5%), ajusta kelvin (erro 2-5%), grava EMA (estavel).
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_cozinha
        to: "on"
      - trigger: time_pattern
        minutes: "/1"
    conditions:
      - condition: state
        entity_id: input_boolean.smart_light_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.sensor_cozinha
        state: "on"
      - condition: state
        entity_id: timer.smart_light_cozinha_manual
        state: "idle"
    actions:
      - variables:
          lux_atual: "{{ states('sensor.sensor_cozinha_iluminancia') | float(0) }}"
          lux_alvo: "{{ states('sensor.cozinha_lux_alvo') | float(390) }}"
          erro_pct: "{{ ((lux_atual - lux_alvo) / [lux_alvo, 1] | max * 100) | round(1) }}"
          erro_abs: "{{ erro_pct | float | abs }}"
          br_raw: "{{ state_attr('light.cz05_cozinha_luz', 'brightness') | float(0) }}"
          br_pct: "{{ (br_raw / 2.55) | round(1) }}"
          k_atual: "{{ state_attr('light.cz05_cozinha_luz', 'color_temp_kelvin') | int(5700) }}"
          k_alvo: "{{ states('sensor.cozinha_kelvin_alvo') | int(5700) }}"
          luz_on: "{{ is_state('light.cz05_cozinha_luz', 'on') }}"
          slot: "{{ states('sensor.cozinha_slot_horario') | int(3) }}"
          learned_entity: "input_number.coz_learned_br_{{ slot }}"
          learned_br: "{{ states(learned_entity) | float(50) }}"
          confianca: "{{ states('sensor.cozinha_confianca_varanda') | float(50) }}"
          cal: "{{ states('input_number.cal_coz_luz') | float(570) }}"
          min_coz: "{{ states('input_number.min_brilho_cozinha') | int(40) }}"
      - choose:
          # ── CASO 1: Luz OFF → ligar com baseline aprendido ──
          - conditions:
              - "{{ not luz_on }}"
            sequence:
              - variables:
                  inicio_br: >
                    {% if confianca | float > 80 %}
                      {{ learned_br }}
                    {% else %}
                      {{ [((lux_alvo - lux_atual) / cal * 100) | round(0), 5] | max }}
                    {% endif %}
              - action: light.turn_on
                target:
                  entity_id: light.cz05_cozinha_luz
                data:
                  brightness_pct: "{{ [[inicio_br | int, 100] | min, min_coz | int] | max }}"
                  kelvin: "{{ k_alvo }}"
                  transition: 3

          # ── CASO 2: Erro > 5% → ajuste de BRILHO (proporcional) ──
          - conditions:
              - "{{ luz_on and erro_abs | float > 5 }}"
            sequence:
              - variables:
                  step: >
                    {% set e = erro_pct | float %}
                    {% set s = (e / -4) | round(1) %}
                    {% if s > 0 %}{{ [s, 8] | min | round(0) }}
                    {% else %}{{ [s, -8] | max | round(0) }}{% endif %}
                  novo_br: "{{ [[br_pct | float + step | float, 100] | min, min_coz | int] | max | round(0) }}"
              - action: light.turn_on
                target:
                  entity_id: light.cz05_cozinha_luz
                data:
                  brightness_pct: "{{ novo_br }}"
                  kelvin: "{{ k_alvo }}"
                  transition: 2

          # ── CASO 3: Erro 2-5% → ajuste fino de KELVIN ──
          - conditions:
              - "{{ luz_on and erro_abs | float > 2 and erro_abs | float <= 5 }}"
            sequence:
              - variables:
                  k_step: >
                    {% set e = erro_pct | float %}
                    {% if e > 0 %}{{ -150 }}{% else %}{{ 150 }}{% endif %}
                  novo_k: "{{ [[k_atual + k_step | int, 6500] | min, 4500] | max }}"
              - action: light.turn_on
                target:
                  entity_id: light.cz05_cozinha_luz
                data:
                  brightness_pct: "{{ br_pct | int }}"
                  kelvin: "{{ novo_k }}"
                  transition: 2

          # ── CASO 4: Erro ≤ 2% → ESTAVEL → atualizar aprendizado ──
          - conditions:
              - "{{ luz_on and erro_abs | float <= 2 }}"
            sequence:
              - action: input_number.set_value
                target:
                  entity_id: "input_number.coz_learned_br_{{ slot }}"
                data:
                  value: >
                    {{ (learned_br | float * 0.85 + br_pct | float * 0.15) | round(0) }}
    mode: restart

  # ─── COZINHA: desligar sem presenca ───
  - id: smart_light_cozinha_off
    alias: Smart Light Cozinha - Sem Presenca
    description: Desliga cozinha apos timeout (8min dia / 2min madrugada)
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_cozinha
        to: "off"
    actions:
      - delay:
          minutes: >
            {% set h = now().hour %}
            {% if 8 <= h < 22 %}8
            {% else %}2{% endif %}
      - condition: state
        entity_id: binary_sensor.sensor_cozinha
        state: "off"
      - action: light.turn_off
        target:
          entity_id: light.cz05_cozinha_luz
        data:
          transition: 5
    mode: restart

  # ─── ESCRITORIO: detecta override manual ───
  - id: smart_light_escritorio_manual_override
    alias: Smart Light Escritorio - Override Manual
    description: Pausa modo auto 30min ao controlar luz manualmente
    triggers:
      - trigger: state
        entity_id:
          - light.escritorio_difusa001_luz
          - light.escritorio_difusa002_luz_2
          - light.escritorio_spot001_luz
          - light.escritorio_spot002_luz_3
    conditions:
      - condition: template
        value_template: "{{ trigger.to_state.context.user_id is not none }}"
    actions:
      - action: timer.start
        target:
          entity_id: timer.smart_light_escritorio_manual
    mode: restart

  # ─── ESCRITORIO: ajuste com presenca ───
  - id: smart_light_escritorio_on
    alias: Smart Light Escritorio - Ajuste Presenca
    description: >
      Controla 4 luzes CCT do escritorio (2 difusas + 2 spots) por presenca e lux.
      Brilho proporcional ao deficit de lux, kelvin circadiano.
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_escritorio
        to: "on"
      - trigger: time_pattern
        minutes: "/3"
    conditions:
      - condition: state
        entity_id: input_boolean.smart_light_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.sensor_escritorio
        state: "on"
      - condition: state
        entity_id: timer.smart_light_escritorio_manual
        state: "idle"
    actions:
      - variables:
          brilho: "{{ states('sensor.escritorio_brilho_alvo') | int(0) }}"
          kelvin: "{{ states('sensor.iluminacao_kelvin_alvo') | int(3000) }}"
      - if:
          - condition: template
            value_template: "{{ brilho > 2 }}"
        then:
          - action: light.turn_on
            target:
              entity_id:
                - light.escritorio_difusa001_luz
                - light.escritorio_difusa002_luz_2
                - light.escritorio_spot001_luz
                - light.escritorio_spot002_luz_3
            data:
              brightness_pct: "{{ brilho }}"
              kelvin: "{{ kelvin }}"
              transition: 3
        else:
          - action: light.turn_off
            target:
              entity_id:
                - light.escritorio_difusa001_luz
                - light.escritorio_difusa002_luz_2
                - light.escritorio_spot001_luz
                - light.escritorio_spot002_luz_3
            data:
              transition: 5
    mode: restart

  # ─── ESCRITORIO: desligar sem presenca ───
  - id: smart_light_escritorio_off
    alias: Smart Light Escritorio - Sem Presenca
    description: Desliga escritorio apos timeout (10min dia / 3min madrugada)
    triggers:
      - trigger: state
        entity_id: binary_sensor.sensor_escritorio
        to: "off"
        for:
          minutes: 1
    actions:
      - delay:
          minutes: >
            {% set h = now().hour %}
            {% if 8 <= h < 22 %}10
            {% else %}3{% endif %}
      - condition: state
        entity_id: binary_sensor.sensor_escritorio
        state: "off"
      - action: light.turn_off
        target:
          entity_id:
            - light.escritorio_difusa001_luz
            - light.escritorio_difusa002_luz_2
            - light.escritorio_spot001_luz
            - light.escritorio_spot002_luz_3
        data:
          transition: 10
      - action: timer.cancel
        target:
          entity_id: timer.smart_light_escritorio_manual
    mode: restart

  # ─── ALERTA: bateria baixa ───
  - id: smart_sensors_battery_low
    alias: Sensores - Alerta Bateria Baixa
    description: Notificacao quando bateria cai abaixo de 20%
    triggers:
      - trigger: numeric_state
        entity_id:
          - sensor.sensor_sala_bateria
          - sensor.sensor_corredor_bateria
          - sensor.sensor_cozinha_bateria
          - sensor.sensor_varanda_bateria
          - sensor.sensor_escritorio_bateria
        below: 20
    actions:
      - action: persistent_notification.create
        data:
          title: "Bateria Baixa"
          message: >
            {{ trigger.to_state.attributes.friendly_name }}:
            {{ trigger.to_state.state }}%. Trocar bateria.
          notification_id: "battery_{{ trigger.entity_id | replace('.', '_') }}"
    mode: queued
